<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>الملف الشخصي</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="profile-top-nav">
      <a href="index.html" class="icon-btn"><i class="fas fa-arrow-right"></i></a>
      <div class="top-actions">
          <button class="icon-btn"><i class="fas fa-share"></i></button>
          <button class="icon-btn"><i class="fas fa-ellipsis-v"></i></button>
      </div>
  </div>

  <div class="profile-header">
      <div class="cover-photo" id="coverPhoto"></div>
      <div class="profile-avatar-container">
          <img id="profileImage" src="https://via.placeholder.com/100" alt="Avatar">
      </div>
      <button id="editProfileBtn" class="edit-profile-btn">تعديل الملف الشخصي</button>
  </div>

  <div class="profile-info-section">
      <h1 id="displayName">جاري التحميل...</h1>
      <span id="usernameDisplay" class="handle">@loading</span>
      
      <p id="bioDisplay" class="bio-text">لا توجد نبذة تعريفية بعد.</p>
      
      <div class="meta-info">
          <span><i class="fas fa-map-marker-alt"></i> <span id="locationDisplay">غير محدد</span></span>
          <span><i class="fas fa-calendar-alt"></i> انضم في <span id="joinDate">...</span></span>
      </div>

      <div class="follow-stats">
          <span><strong>4.2K</strong> يتابع</span>
          <span><strong>30K</strong> المتابعون</span>
      </div>
  </div>

  <div class="profile-tabs">
      <div class="p-tab active">المنشورات</div>
      <div class="p-tab">سجل النشاطات</div>
      <div class="p-tab">الإحصائيات</div>
  </div>

  <div id="userPostsFeed" class="profile-feed">
      <div class="loading-spinner">جاري تحميل المنشورات...</div>
  </div>

  <div id="editProfileModal" class="full-screen-modal">
      <div class="modal-header">
          <button id="closeEditModal"><i class="fas fa-arrow-right"></i></button>
          <span>تعديل الملف الشخصي</span>
          <button id="saveProfileBtn" class="text-btn">حفظ</button>
      </div>
      
      <div class="modal-body">
          <div class="edit-images-area">
              <div class="edit-cover">
                  <div class="overlay"><i class="fas fa-camera"></i></div>
              </div>
              <div class="edit-avatar">
                  <img id="editAvatarPreview" src="https://via.placeholder.com/80">
                  <div class="overlay" onclick="document.getElementById('fileInput').click()"><i class="fas fa-camera"></i></div>
              </div>
              <input type="file" id="fileInput" hidden>
          </div>

          <div class="edit-form">
              <div class="input-group">
                  <label>الاسم الكامل</label>
                  <input type="text" id="editNameInput">
                  <span class="hint">يمكنك تغيير الاسم مرة واحدة في الشهر</span>
              </div>

              <div class="input-group">
                  <label>النبذة التعريفية</label>
                  <textarea id="editBioInput" rows="3"></textarea>
              </div>

              <div class="input-group">
                  <label>الموقع الجغرافي</label>
                  <input type="text" id="editLocationInput">
              </div>
          </div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBo_O8EKeS6jYM-ee12oYrIlT575oaU2Pg",
      authDomain: "clan-forum.firebaseapp.com",
      projectId: "clan-forum",
      storageBucket: "clan-forum.firebasestorage.app",
      messagingSenderId: "1011903491894",
      appId: "1:1011903491894:web:f1bc46a549e74b3717cd97"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const displayName = document.getElementById('displayName');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const bioDisplay = document.getElementById('bioDisplay');
    const locationDisplay = document.getElementById('locationDisplay');
    const profileImage = document.getElementById('profileImage');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const editProfileModal = document.getElementById('editProfileModal');
    const closeEditModal = document.getElementById('closeEditModal');
    const userPostsFeed = document.getElementById('userPostsFeed');
    
    // Edit Elements
    const editNameInput = document.getElementById('editNameInput');
    const editBioInput = document.getElementById('editBioInput');
    const editLocationInput = document.getElementById('editLocationInput');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const fileInput = document.getElementById('fileInput');
    const editAvatarPreview = document.getElementById('editAvatarPreview');

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            loadUserProfile(user.uid);
            loadUserPosts(user.uid);
        } else {
            window.location.href = 'index.html';
        }
    });

    // 1. تحميل البيانات
    async function loadUserProfile(uid) {
        const docRef = doc(db, "users", uid);
        const snap = await getDoc(docRef);
        
        if (snap.exists()) {
            const data = snap.data();
            displayName.textContent = currentUser.displayName;
            usernameDisplay.textContent = data.username ? `@${data.username}` : '@user';
            bioDisplay.textContent = data.bio || "لم يتم إضافة نبذة تعريفية.";
            locationDisplay.textContent = data.location || "غير محدد";
            profileImage.src = currentUser.photoURL;
            editAvatarPreview.src = currentUser.photoURL; // للصورة في المودال
            
            // ملء حقول التعديل
            editNameInput.value = currentUser.displayName;
            editBioInput.value = data.bio || "";
            editLocationInput.value = data.location || "";
        }
    }

    // 2. تحميل منشورات المستخدم فقط
    async function loadUserPosts(uid) {
        userPostsFeed.innerHTML = ''; // مسح
        const q = query(collection(db, "posts"), where("authorId", "==", uid), orderBy("createdAt", "desc"));
        
        try {
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                userPostsFeed.innerHTML = '<div style="text-align:center; padding:20px; color:#777;">لا توجد منشورات بعد.</div>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const post = doc.data();
                const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : '';
                
                const postHTML = `
                    <div class="post-card">
                        <div class="post-header">
                            <img src="${post.authorAvatar}" class="user-avatar">
                            <div class="post-info">
                                <span class="user-name">${post.authorName}</span>
                                <span class="post-handle">${usernameDisplay.textContent}</span>
                                <span class="post-time">${date}</span>
                            </div>
                            <i class="fas fa-thumbtack" style="color:#3498db; margin-right:auto; font-size:0.8rem;"></i>
                        </div>
                        <div class="post-body">${post.text}</div>
                        <div class="post-actions">
                            <div class="action"><i class="far fa-heart"></i> 0</div>
                            <div class="action"><i class="far fa-comment"></i> 0</div>
                            <div class="action"><i class="fas fa-share"></i></div>
                        </div>
                    </div>
                `;
                userPostsFeed.insertAdjacentHTML('beforeend', postHTML);
            });
        } catch (e) {
            console.error(e);
            userPostsFeed.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">فشل تحميل المنشورات (تأكد من الـ Index في Firebase).</div>';
        }
    }

    // 3. فتح وغلق المودال
    editProfileBtn.onclick = () => editProfileModal.style.display = 'flex';
    closeEditModal.onclick = () => editProfileModal.style.display = 'none';

    // 4. حفظ التعديلات
    saveProfileBtn.onclick = async () => {
        if(!currentUser) return;
        saveProfileBtn.textContent = "...";
        
        try {
            // تحديث الاسم في Auth
            if(editNameInput.value !== currentUser.displayName) {
                await updateProfile(currentUser, { displayName: editNameInput.value });
            }
            
            // تحديث باقي البيانات في Firestore
            const userRef = doc(db, "users", currentUser.uid);
            await updateDoc(userRef, {
                bio: editBioInput.value,
                location: editLocationInput.value
            });
            
            location.reload(); // إعادة تحميل لرؤية التغييرات
        } catch(e) {
            alert("حدث خطأ: " + e.message);
            saveProfileBtn.textContent = "حفظ";
        }
    };

    // 5. تغيير الصورة (صورة فقط بدون رفع لتبسيط الكود حالياً)
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const base64 = ev.target.result;
            // تحديث الواجهة فوراً
            editAvatarPreview.src = base64;
            // الحفظ
            await updateProfile(currentUser, { photoURL: base64 });
            await updateDoc(doc(db, "users", currentUser.uid), { photoURL: base64 });
        };
        reader.readAsDataURL(file);
    };

  </script>
</body>
</html>
